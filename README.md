# ytfetcher

Telegram бот, который принимает ссылку на видео, позволяет выбрать качество и выдаёт ссылку на скачанный файл, раздаваемый локальным nginx. В основе загрузки используется `yt-dlp`.

## Локальный запуск
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -e .[dev]
   ```
2. Скопируйте `.env.example` в `.env` и заполните переменные (`TELEGRAM_BOT_TOKEN`, `PUBLIC_BASE_URL`, при необходимости `DOWNLOAD_ROOT`). Если планируется HTTPS прямо в контейнере, также укажите `ENABLE_TLS=true`, `SERVER_NAME` и пути к сертификатам.
3. Убедитесь, что в системе установлен `ffmpeg` и `nginx`, либо поднимите их отдельно.
4. Запустите приложение:
   ```bash
   python main.py
   ```
5. Настройте nginx на раздачу каталога с файлами (`DOWNLOAD_ROOT`) по пути `/downloads/` с заголовком `Content-Disposition: attachment`, чтобы браузер сразу предлагал скачать файл. Бот будет отправлять пользователю ссылку вида `PUBLIC_BASE_URL/downloads/<имя_файла>`, в названии присутствует очищенное название ролика и короткий идентификатор.

## Docker
1. Соберите образ:
   ```bash
   docker build -t ytfetcher .
   ```
2. Запустите контейнер, пробросив порт nginx и передав переменные окружения (можно использовать `--env-file .env`):
   ```bash
   docker run --rm \
     -p 8080:8080 \
     -e TELEGRAM_BOT_TOKEN=123456:ABC \
     -e PUBLIC_BASE_URL=http://localhost:8080 \
     ytfetcher
   ```
3. После выбора качества бот пришлёт сообщение с прямой ссылкой на файл. Скачивание возможно до тех пор, пока файл остаётся в каталоге `/srv/ytfetcher/downloads` внутри контейнера (смонтируйте том, если нужна долговременная сохранность).

### Docker Compose
1. Заполните `.env` (можно использовать `.env.example` как шаблон).
2. Запустите сервис с именованным томом для загрузок:
   ```bash
   docker compose up -d
   ```
3. Чтобы получить сертификат Let’s Encrypt через webroot-проверку:
   ```bash
   docker compose run --rm --profile certbot certbot certonly \
     --webroot -w /var/www/certbot \
     -d "$SERVER_NAME"
   ```
   После успешной выдачи включите TLS (`ENABLE_TLS=true`) и перезапустите сервис: `docker compose up -d --build`. Если контейнер не найдёт указанные файлы сертификата/ключа, он продолжит работать по HTTP и выведет предупреждение в лог.
4. Загрузки будут храниться в томе `downloads` (посмотрите путь через `docker volume inspect downloads`).
5. Остановить сервис: `docker compose down` (используйте `--volumes`, если хотите удалить накопленные файлы).

Логи приложения и nginx доступны через `docker logs`. Для очистки старых файлов добавьте внешнюю задачу (cron/скрипт) по вашему усмотрению.
